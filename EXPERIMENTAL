â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     AcousticAnalysis: Extremely experimental and probably doesn't work.      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘           Copyright Â©2021 Jim Birch (https://angularfish.net)                â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘This program is free software; you can redistribute it and/or modify it under â•‘
â•‘the terms of the GNU General Public License as published by the Free Software â•‘
â•‘Foundation; either version 2 of the License, or (at your option) any later    â•‘
â•‘version. It's not required, but please let me know if you find this useful.   â•‘
â•‘                                                                              â•‘
â•‘This program is a hobby project distributed in the hope that it will be usefulâ•‘
â•‘but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITYâ•‘
â•‘or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for   â•‘
â•‘more details.                                                                 â•‘
â•‘                                                                              â•‘
â•‘You should have received a copy of the GNU General Public License along with  â•‘
â•‘this program; if not, write to the Free Software Foundation, Inc., 51 Franklinâ•‘
â•‘Street, Fifth Floor, Boston, MA 02110-1301 USA.                               â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘Welcome to the EXPERIMENTAL section. The analyses here are incomplete, buggy, â•‘
â•‘and generally not ready for prime time (as if anything else in this repo is). â•‘
â•‘If all you want to do is georeference some transects for visual classificationâ•‘
â•‘turn back now. This isn't your final warning, but I'm not going to make a poi-â•‘
â•‘n't to keep bringing it up. If you decide you want to try these analyses, see â•‘
â•‘the build section of this document for information on how to include it in yo-â•‘
â•‘ur copy of my program. Also check the included analyses and maturity section  â•‘
â•‘to determine the suitability of this software for what you want to do. Lastly â•‘
â•‘I strongly encourage you to read the corresponding section describing the ana-â•‘
â•‘lysis in this document. If you've heeded all of my warnings and still feel th-â•‘
â•‘is is right for you, good luck! I hope you find this code helpful.            â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘This software is experimental, likely unreliable, probably full of bugs, and  â•‘
â•‘written by a biologist. It is likely to break my computer, break your compu-  â•‘
â•‘ter, do irreparable harm to your data, break off your relationships, or dial  â•‘
â•‘into a cold war-era nuclear weapons targeting system and force you to teach anâ•‘
â•‘aggressive AI how to play tic-tac-to to avert the extinction of humanity and  â•‘
â•‘every other living thing on this planet in an extended commentary on the futi-â•‘
â•‘lity of preparing for nuclear war in the early 1980s.                         â•‘
â•‘                                                                              â•‘
â•‘Use this program at your own risk and back up your data often. Maybe run it onâ•‘
â•‘a machine you don't care about. I strongly recommend not running analyses in  â•‘
â•‘the same folder you store your original SON files in. Don't cry to me if you  â•‘
â•‘ruin your life using this code, but please file a bug report or otherwise let â•‘
â•‘me know about it.                                                             â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘You've read through two flowery warnings about using this software and are st-â•‘
â•‘ill here because of course you are. You are the type of person who wants to doâ•‘
â•‘serious analysis using a fishfinder you bought for less than $500CAD. You are â•‘
â•‘either super low-budget, or like me you think a good study site is one where  â•‘
â•‘you get to shoot rapids a few times a day and this small unit is great for th-â•‘
â•‘at. You're a risk taker and this is a challenge. Welcome again and I hope you â•‘
â•‘stay. This software is specifically written to analyze data from the Humminbi-â•‘
â•‘rd 598ci HD combo side-imaging and down imaging fish finder, run in fresh     â•‘
â•‘water (a Canadian Shield river in my case). It can be modified to run in otherâ•‘
â•‘(read: seawater) conditions or with other units. See the other text files in  â•‘
â•‘this folder for more information, and if you need help ask for help. I may notâ•‘
â•‘respond immediately, but I promise that if you've even bothered to download   â•‘
â•‘this repository I am extremely interested.                                    â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘                     EXPERIMENTAL ACOUSTIC ANALYSES                           â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘acousticanalysis.h:    Physical metadata for the down-imaging transducer,     â•‘
â•‘                       prototypes for acoustic analysis functions.            â•‘
â•‘acousticfunctions.cpp: Acoustic analysis functions and data processing.       â•‘
â•‘                       Details listed below.                                  â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘                    REQUIRED FILES FROM SONARGRIDDER                          â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘songridder.h:     Physical metadata and file format macros, function          â•‘
â•‘                  prototypes.                                                 â•‘
â•‘processfiles.cpp: Common functions for all files used in the analysis         â•‘
â•‘main.cpp:         Command line processing and help                            â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘Suggested citation:                                                           â•‘
â•‘Birch, J. 2021. SonarGridder: A utility for georeferencing consumer-grade sideâ•‘
â•‘-scan sonar files. URL: https://angularfish.net                               â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘   Please let me know if you find this software useful! jim[Ã¡]jdbirch.com     â•‘
â•‘                 (Or if you can't get it to run at all)                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

################################################################################
################################################################################
################################################################################

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘Included analyses and their current maturity level:                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘1. Roughness and hardness analysis (E1 and E2):                               â•‘
â•‘   Sort of working. Doesn't use real units, water attenuation is not included,â•‘
â•‘   relies on assumptions that may or may not be correct.                      â•‘
â•‘2. Peak detection and noise removal:                                          â•‘
â•‘   Works maybe 70% of the time. May not be necessary for analysis, depending  â•‘
â•‘   on how well the unit calculates depth.                                     â•‘
â•‘3. Automatic noise floor calculation:                                         â•‘
â•‘   Works reasonably well. There might be a compelling reason to not use it.   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

################################################################################
################################################################################
################################################################################

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘Compiling the software with the experimental analyses included:               â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘Experimental analyses are built into the make file under the "experimental"   â•‘
â•‘target. Remove any previous builds. Update header files for salt water or to  â•‘
â•‘account for your specific unit as necessary (see BUILDING for more info)      â•‘
â•‘                                                                              â•‘
â•‘1. make clean                                                                 â•‘
â•‘2. make experimental                                                          â•‘
â•‘3. (optional) sudo make install                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

################################################################################
################################################################################
################################################################################

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘Roughness and hardness (E1 and E2):                                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘I would be remiss to not acknowledge that my motivation for attempting this   â•‘
â•‘analysis was based on my inability to get Dan Buscombe (dbuscombe.github.io)'sâ•‘
â•‘PyHum to run in the year of our lord 2021. Why Python needed to obsolete deca-â•‘
â•‘des of other peoples' code is beyond the scope of this document. This code is â•‘
â•‘different from the E1 and E2 analysis in PyHum in several key ways, the ratio-â•‘
â•‘nale for which I will include below. I also have no desire to recreate PyHum, â•‘
â•‘nor use a fully automatic method to classify substrate. If this is your goal  â•‘
â•‘more power to you, feel free to use my code in your project.                  â•‘
â•‘                                                                              â•‘
â•‘This analysis is not super complicated, and I'd recommend Dan Buscombe's 2017 â•‘
â•‘paper as well as Barb Faggetter's documentation at Oceanecology.ca as invalua-â•‘
â•‘ble resources for understanding what is going on (citations below). Also I'd  â•‘
â•‘like to extend a huge thank you here to both of these folks for the huge      â•‘
â•‘amount of work that they have both done!                                      â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘E1 and E2 analysis is a method of using the strength of returns in the first  â•‘
â•‘and second sonar echos to classify substrate. The first echo is the direct ba-â•‘
â•‘ckscatter from the substrate (ie the wave front has propagated from the trans-â•‘
â•‘ducer to the bottom and reflected directly back). The second echo is the back-â•‘
â•‘scatter from the bottom after the wave front has reflected off the bottom, re-â•‘
â•‘flected off the surface, and then reflected off the bottom again.             â•‘
â•‘                                                                              â•‘
â•‘Researchers have noticed that the strength of the first echo roughly correspo-â•‘
â•‘nds to the roughness of the substrate, and the second roughly corresponds to  â•‘
â•‘its reflectivity (hardness). There are reasons why this isn't always the case â•‘
â•‘but this is documentation and I'm a biologist. See the recommended reading forâ•‘
â•‘more info.                                                                    â•‘
â•‘                                                                              â•‘
â•‘Measuring the strength of each echo involves taking the area under the curve  â•‘
â•‘of these two peaks, and correcting them for water attenuation and noise. The  â•‘
â•‘units are an area over a volume (an inverse length), and are traditionally    â•‘
â•‘reported in inverse nautical miles. We won't worry about units here for a few â•‘
â•‘reasons, not the least of which being that surface and environmental conditio-â•‘
â•‘ns affect results enough that literature-reported values are useless for clas-â•‘
â•‘sification in most situations anyway. It is important to test these values ag-â•‘
â•‘ainst known substrates in the system you are using them in.                   â•‘
â•‘                                                                              â•‘
â•‘Classification is typically accomplished using a clustering algorithm. Both   â•‘
â•‘Faggetter and Buscombe use k-means clustering and I think that is a solid opt-â•‘
â•‘ion. I do no automatic clustering here so I'll leave that part up to you.     â•‘
â•‘                                                                              â•‘
â•‘Currently this software does not factor in water attenuation of the signal andâ•‘
â•‘assumes the returns reported by the instrument are logarithmic. Please see be-â•‘
â•‘low for the missing information that is necessary to do this analysis right.  â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘Things we need to know to do this right but don't know. As far as I know      â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘1. What do the return values in the binary file correspond to? This is extrem-â•‘
â•‘   ely important for factoring in water attenuation, which is expressed in theâ•‘
â•‘   equation I borrowed from Barb Faggetter in decibel watts. Buscombe (2017)  â•‘
â•‘   assumes that the maximum return (255) is equal to the power output from theâ•‘
â•‘   unit. I'm not going to call that assumption unreasonable, but I would not  â•‘
â•‘   design the instrument in this way. Further, returns of 255 are common even â•‘
â•‘   10+ m down. I think the assumption that 0 is no return is very reasonable. â•‘
â•‘   Faggetter represents return values in Sv, representing a variation in dyna-â•‘
â•‘   mic range assumed to be 70dB. This may partially answer the next question. â•‘
â•‘2. Similarly, are the returns linear or logarithmic? I can think of a few waysâ•‘
â•‘   to set up an ADC to read amplitude, and assume that a direct measurement   â•‘
â•‘   from a DAC sampling at least twice as fast as the frequency (in this case  â•‘
â•‘   the DAC would need to be in the ballpark of 1 Mhz), would produce a linear â•‘
â•‘   response; but if the signal is rectified and used to charge a capacitor,   â•‘
â•‘   and then read by a slower ADC, the response would likely be logarithmic. I â•‘
â•‘   am assuming the response is logarithmic but am unwilling to disassemble my â•‘
â•‘   fishfinder to find out.                                                    â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘Problems that will always plague this analysis that I don't think can be fixedâ•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘1. Clipping. The return is expressed as an 8-bit unsigned integer. The energy â•‘
â•‘   responsible for the maximum return of 255 is unknown, but if it, as I susp-â•‘
â•‘   ect, is lower than the output power, returns higher than 255 are probably  â•‘
â•‘   recorded as 255. The area under the curve of strong peaks in this analysis â•‘
â•‘   will always be underestimated in a way that is related to the number of re-â•‘
â•‘   turns that are recorded as 255 but should be higher. This probably transla-â•‘
â•‘   tes to unreliable results in shallow depths at an unknown depth cutoff tha-â•‘
â•‘   t likely depends on substrate and the particular noise environment in the  â•‘
â•‘   study area.                                                                â•‘
â•‘2. Unknown variability between instruments. Signal strength and gain will varyâ•‘
â•‘   within manufacturing tolerences that we just don't know. I suspect they areâ•‘
â•‘   not super stringent considering that the intended use of this device is in-â•‘
â•‘   situ visual interpretation in a recreational setting.                      â•‘
â•‘3. To my knowledge we don't know whether the instrument dynamically adjusts   â•‘
â•‘   its gain, output, or the duration of its pings. If it does any of these th-â•‘
â•‘   ings and doesn't record the corresponding adjustments, there is no meaning-â•‘
â•‘   ful way to compare the results of this analysis.                           â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘Suggested reading                                                             â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘Buscombe, D. 2017. Shallow water benthic imaging and substrate characterizati-â•‘
â•‘ on using recreational-grade sidescan-sonar. Environmental Modelling and Soft-â•‘
â•‘ ware. 89. pp 1-18                                                            â•‘
â•‘Faggetter, B. 46. Humminbird Raw Sonar Data. Accessed 2019-09-15              â•‘
â•‘ https://oceanecology.ca/publications/Humminbird%20Raw%20Sonar%20Data.pdf     â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘Considerations if you decide to use this software for analysis                â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘1. You are using a recreational fish finder to do science. If you have the fu-â•‘
â•‘   nding to not do this, please consider using it. An ADCP, multi-beam unit,  â•‘
â•‘   or properly calibrated, research-grade sonar unit that gives returns in dB â•‘
â•‘   Watts will keep you from pulling out your hair over the analysis ðŸ™ƒ.       â•‘
â•‘2. Currently water attenuation is not factored in to this analysis. This meansâ•‘
â•‘   that E1 and E2 values will not scale correctly with depth. If your study   â•‘
â•‘   site has a relatively consistent depth, this might not matter (congrats youâ•‘
â•‘   lucky SOB). Otherwise you will need a way to include depth in your analysisâ•‘
â•‘   (bin similar depths before clustering, etc.)                               â•‘
â•‘3. Be comfortable with my assumptions, don't use this analysis, or modify the â•‘
â•‘   code to your own ends. I've given my rationale for the assumptions I've ma-â•‘
â•‘   de, but the numbers will be wildly wrong if, for instance, returns are act-â•‘
â•‘   ually linear. YMMV                                                         â•‘
â•‘4. Consider the first unresolvable problem: there is almost certainly a minim-â•‘
â•‘   um depth that this analysis will work in and I can't tell you what it is.  â•‘
â•‘   You might be able to figure it out by looking at some lines to see the max-â•‘
â•‘   imum return in the depth peak. I expect that the minimum useful depth is   â•‘
â•‘   the maximum depth at which values of 255 regularly occur in the depth peak.â•‘
â•‘   You might be able to use a statistical method to correct for the clipping, â•‘
â•‘   though I don't know one offhand, or you might get away with running the an-â•‘
â•‘   alysis anyway if your system has a relatively constant depth. Again YMMV   â•‘
â•‘5. The units reported by this software are non-standard and likely not report-â•‘
â•‘   able in the literature without referencing how they were calculated.       â•‘
â•‘6. This is an extremely experimental program written by a fish biologist with â•‘
â•‘   too much free time during a global pandemic. If you find it useful, more   â•‘
â•‘   power to you. If it breaks your computer, c'est la vie. Back up your data  â•‘
â•‘   often, keep your coffee pot full, and be prepared for the unexpected.      â•‘
â•‘7. If you've read this far and you still want to give this a try. Godspeed.   â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘Offer of help and request for the same                                        â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘If you are doing/have done/are planning to do calibrations on this or a relat-â•‘
â•‘ed instrument that could answer the big questions, please don't hesitate to   â•‘
â•‘contact me. My email is jim[Ã¡]jdbirch.com. I am willing to help with any anal-â•‘
â•‘yses, including providing insight into the binary file format, loaning my ins-â•‘
â•‘trument (provided you aren't looking to destroy it), providing data, or helpi-â•‘
â•‘ng with fieldwork. I'm also willing to accept additional information if you   â•‘
â•‘just know it offhand, especially with a source!                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

################################################################################
################################################################################
################################################################################

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘Peak detection and noise reduction:                                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘Finding and verifying depth is an important step for getting reliable data outâ•‘
â•‘of signal analyses. The unit does an internal calculation of depth that seems â•‘
â•‘reasonably reliable. I've included some functions for detecting peaks indepen-â•‘
â•‘dently with the aim of creating a reliable method for determining the width ofâ•‘
â•‘the return peaks. The procedure used by the peak detection function follows:  â•‘
â•‘                                                                              â•‘
â•‘1. Open a line (the returns associated with a single ping).                   â•‘
â•‘2. Compute a running average (Î¼) ending with the return being analyzed.       â•‘
â•‘3. If the return (r) was different from Î¼ by A standard deviations (Ïƒ) classi-â•‘
â•‘   fy the return as part of a peak. Record its location.                      â•‘
â•‘   D = r > Î¼ + A * Ïƒ                                                          â•‘
â•‘   D = r < Î¼ - A * Ïƒ                                                          â•‘
â•‘4. If the return was classified as a peak, reduce r toward the mean by 1/3.   â•‘
â•‘   r = 0.67 * (r0 - Î¼) + Î¼                                                    â•‘
â•‘   This increases the probability of classifying subsequent returns as part ofâ•‘
â•‘   a peak and decreases noise in the original line for subsequent runs.       â•‘
â•‘5. Count the peaks, eliminating peaks too short to be anything other than noi-â•‘
â•‘   se.                                                                        â•‘
â•‘6. If there are more than 5 or fewer than 2 peaks, repeat steps 2 through 5 atâ•‘
â•‘   a lower sigma level (A) until the conditions are met or A is 0.            â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘How I use this in the included analyses:                                      â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘A version of this analysis tuned to be somewhat more reliable than what I am  â•‘
â•‘currently doing could allow depth calculation independent of the unit's inter-â•‘
â•‘nal calculation (read: fully user-specifiable speed of sound). It is also a   â•‘
â•‘starting point for the noise classification and peak width calculation detail-â•‘
â•‘ed in the next section. Peak detection could also be helpful for automated cl-â•‘
â•‘assification methods using the side-imaging transducers (shoreline detection, â•‘
â•‘rock detection, etc.). Noise reduction is also potentially helpful for image  â•‘
â•‘clarification in the side-imaging TIFFs, but is not currently used in this wayâ•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

################################################################################
################################################################################
################################################################################

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘Automatic noise floor and peak width calculation:                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘Noise is calculated in two ways in this software. The noise used in calculati-â•‘
â•‘ng E is, by definition, backscatter from the water column and is the average  â•‘
â•‘return prior to the peak corresponding the depth. Noise is also necesary for  â•‘
â•‘determining the breadth of the first two peaks. This noise floor is defined byâ•‘
â•‘the water column noise plus the continuous component of the backscatter from  â•‘
â•‘the bottom (the ringing caused by the wave front outside of the beam width andâ•‘
â•‘local echos between different parts of the substrate that return at unpredict-â•‘
â•‘able times). Since the water column noise is part of these returns anyway, we â•‘
â•‘can ignore it for this algorithm. The ringing reduces over time, and the impo-â•‘
â•‘rtant component is the space between the tail end of the first echo and the   â•‘
â•‘beginning of the second. This software calculates the noise floor using the   â•‘
â•‘following procedure:                                                          â•‘
â•‘                                                                              â•‘
â•‘1. Determine the location in the line of the peaks associated with both echos.â•‘
â•‘2. Select a (roughly) 1 metre section of the line to sample for noise:        â•‘
â•‘   2a. If the second echo is more than 2 metres from the first, select the me-â•‘
â•‘       re surrounding the midpoint between the two.                           â•‘
â•‘   2b. If the second echo is less than 2 metres from the first (the depth is  â•‘
â•‘       less than 2 metres), select a one-metre section of the line 1.5 metres â•‘
â•‘       after the second echo.                                                 â•‘
â•‘3. Scan through the selected noise region and calculate the average return.   â•‘
â•‘4. Set the noise floor ten percent higher than the average noise return. This â•‘
â•‘   is done to remove noise from the noise floor. lol                          â•‘
â•‘5. Adjust the peak widths so that they start and end with the first value     â•‘
â•‘   above the noise floor and the first value below the noise floor, respectiv-â•‘
â•‘   ely.                                                                       â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘How I use this in the included analyses:                                      â•‘
â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢
â•‘The breadth of a return is an important component in calculating the area und-â•‘
â•‘er the curve (E1 or E2). Buscombe (2017) circumvents this calculation by defi-â•‘
â•‘ning the echos using the geometry of the transducer. Whether or not this is a â•‘
â•‘reliable method of comparison is beyond the scope of my knowledge. Faggetter  â•‘
â•‘uses the height of the signal over the noise floor (as I've detailed here) as â•‘
â•‘a method for determining the breadth of the peak. I favour this method as it  â•‘
â•‘is not dependent on defining the geometry of the wave-front (using specs from â•‘
â•‘the instrument that aren't to my knowledge publicly documented). It also fact-â•‘
â•‘ors in the entire peak.                                                       â•‘
â•‘                                                                              â•‘
â•‘I'm not sure if this noise floor should be the noise subtracted from the area â•‘
â•‘under the curve in lieu of the water column noise when calculating E1 or E2. Iâ•‘
â•‘will leave this to the experts. If you are an expert, please let me know.     â•‘
â•‘                                                                              â•‘
â•‘The noise floor calculation used here may be useful in correcting the drop-offâ•‘
â•‘in side-imaging returns associated with attenuation or as a way of calculatingâ•‘
â•‘water attenuation in a sneaky way that relates it directly to the recorded re-â•‘
â•‘turn strength, without needing to know the maximum return. I need to do some  â•‘
â•‘thinking about this, hit the literature, or be told. If you know, please cons-â•‘
â•‘ider sharing your knowledge with me!                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

################################################################################
################################################################################
################################################################################

More to come! (Maybe)
Jim Birch, 2021-09-16
